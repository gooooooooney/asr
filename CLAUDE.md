# AI语音笔记应用 - V1.1 产品需求文档 (完整整合版)

## 修订说明

本次修订为1.1版本，在1.0版本基础上新增了会议Agent模式的完整功能说明，同时保留了所有原有功能。

- **[继承自1.0]** 保留了所有原有功能：FAB交互、笔记卡片系统、智能符号系统、批量操作等
- **[新增]** 双击FAB进入会议Agent模式
- **[新增]** 详细定义了会议Agent的核心功能模块和API调用逻辑
- **[更新]** 基于实际代码实现修正了交互时间阈值
- **[扩展]** 补充了意图识别的多结果处理逻辑

---

## 1.0 核心愿景

本应用旨在提供一种以语音为先、从快速捕捉到深度管理的全流程笔记体验。用户通过一个多功能、情景感知的悬浮按钮（FAB）高效捕捉灵感，并将这些信息固化为可交互、可管理的**笔记卡片**。应用进一步支持对卡片进行编辑、整理和智能处理，构建一个无缝的个人知识管理系统。

**V1.1新增**：应用现支持"会议Agent模式"，提供实时语音转录、智能意图识别和信息检索功能，适用于会议场景下的信息捕获和处理。

## 2.0 核心UI组件

### 2.1 悬浮操作按钮 (Floating Action Button - FAB)

- **别名**: 灵动岛式按钮
- **初始外观**: 一个紧凑、细长的"胶囊"形状
- **风格**: 采用纯白背景与黑色文字的安卓简约设计风格，无透明效果
- **位置**: 静态固定于屏幕垂直方向从上至下4/5处
- **核心职责**: 作为应用所有核心功能的唯一入口点
- **V1.1新增**: 支持双击切换到会议Agent模式

### 2.2 笔记对话框

- **外观**: 纯白背景、黑色文字的卡片式对话框
- **位置**: **总是出现在FAB的正上方**，视觉上形成一种被FAB锚定的关系
- **内容**:
  - 主文本区域：用于显示ASR识别结果或用户手动输入的文字，并支持**智能符号系统**（详见3.6）
  - 功能按钮行：包含"上传图片"和"添加Header"等辅助功能按钮

### 2.3 实时总结对话框

- **外观**: 与笔记对话框风格一致的简约卡片
- **位置**: 固定在屏幕顶部，**位于搜索框正下方**
- **功能**: （仅在特定模式下触发）用于实时、动态地展示对当前笔记内容的简短总结

### 2.4 笔记卡片 (Note Card)

- **触发**: 当用户点击"发送"按钮或完成快速笔记操作后，在主界面创建
- **布局**: 在主界面以**垂直列表**形式展示
- **内容**:
  - **符号栏 (Pill Bar)**:
    - **显示条件**: 仅当笔记包含任何智能符号（#,@,!）时显示
    - **位置**: 位于卡片内容区的最顶部，主文本区域之上
    - **布局**: 所有符号块（Pills）在**一行内水平排列**。当符号块总宽度超过卡片宽度时，该区域支持**水平左右滑动**以查看所有内容
    - **内容**: 集中展示该笔记中所有被创建的智能符号块，并带有各自的颜色样式
  - **文本区域**: 显示完整的ASR识别结果或手动输入的文本内容，其中**智能符号（#,@,!）应有特殊样式**（如高亮或背景色）
  - **音频播放器**:
    - **显示条件**: 仅当该笔记包含原始音频数据时才显示
    - **位置**: **悬浮于卡片的左上角。按钮顶部与卡片顶部对齐，并向上平移自身高度的50%，同时向左侧移出数个像素，形成一种"挂靠"在卡片外的视觉效果**
    - **外观**: 一个非常小巧、独立的微型**文字按钮**，显示为"**播放**"。其宽度约为卡片总宽度的**1/12**
    - **交互**: 点击该"播放"按钮后，播放此笔记对应的原始录音

### 2.5 卡片批量操作视图

- **触发**: 当用户拖动一个或多个已选中的卡片时触发
- **外观**: 一个覆盖全屏的模态视图，背景采用**毛玻璃或模糊效果**，以聚焦当前操作
- **布局**: 屏幕在视觉上**一分为二**
  - **左侧区域**: 垂直排列所有已选中的卡片列表。卡片的排序严格按照用户的**点击选中顺序**
  - **右侧区域**: 显示一个功能操作列表，包含以下选项：
    - AI合并笔记
    - 转发到微信/小红书
    - AI搜索
    - 创建新分类

### 2.6 搜索框 (Search Bar)

- **外观**: 与应用整体风格一致的简约搜索框，可包含搜索图标和占位文字（例如："搜索笔记或 #标签"）
- **位置**: **固定在屏幕最顶部，拥有最高的视觉层级**

### 2.7 智能符号建议弹出框 (Suggestion Popup)

- **外观**: 一个垂直的下拉列表，背景与笔记对话框一致，用于显示匹配的建议项
- **触发**: 在笔记对话框或编辑视图的文本区域内输入**"#"、"@"或"!"**字符时
- **位置**: 紧贴在文本输入光标的下方

### 2.8 MCP中心面板

- **外观**: 一个从屏幕底部向上拉起的半屏面板，背景与对话框一致
- **触发**: 通过上滑FAB手势触发（详见3.4）
- **内容**: 以网格布局展示一系列可交互的MCP应用卡片（参考5.0附录）

### 2.9 会议Agent界面 [V1.1新增]

- **触发**: 双击FAB进入
- **视觉效果**: 全屏蓝色呼吸灯边框动画
- **布局**: 包含以下区域：
  - **意图识别面板**: 右侧固定，显示识别到的意图
  - **搜索结果面板**: 左侧固定，显示搜索结果
  - **VAD状态指示器**: 底部显示语音活动状态
  - **笔记对话框**: 继续显示实时转写内容

### 2.10 用户个人中心 [V1.1新增]

- **触发**: 点击顶部用户头像
- **内容**:
  - API密钥设置（Gemini API Key）
  - 统计信息（笔记总数、标签数量）
  - 其他设置选项

## 3.0 交互流程与功能需求

### 3.1 交互模式一：长按 (启动语音/快速笔记)

**阶段一: 启动与录音**
1. **初始按压 (0s - 0.25s)**: 用户按住FAB。在此期间，FAB外观**不发生任何变化**
2. **开始录音与动画 (按压 > 0.25s)**: 一旦按压时长超过0.25秒，应用立即开始录音，同时FAB的形态开始从"胶囊"平滑地、逐渐地向"长条"过渡。FAB内部显示音频波纹动画

**阶段二: 根据松手时机决定操作**
- **无效操作 (松手于 0.25s - 0.8s)**: 系统提示"录音时间过短"，随后FAB恢复初始状态
- **快速笔记 (松手于 0.8s - 2.1s)**: 系统自动处理已录制的音频，进行ASR转换后，**在主界面直接创建一张新的笔记卡片**。此过程无需用户额外操作，完成后FAB恢复初始状态

**阶段三: 进入完整笔记模式 (按压 ≥ 2.1s)**
1. 当用户长按时间达到2.1秒，系统进入完整笔记模式
2. 在FAB正上方，弹出一个**笔记对话框**，并开始实时显示ASR结果
3. FAB保持其最大长条形态，其内部的音频波纹动画转变为一个居中的**"暂停"文字按钮**

**阶段四: 暂停与控制**
1. **暂停**: 用户点击**"暂停"按钮**，或点击**笔记对话框的文本输入区域**，均可暂停录音
2. **暂停后的状态**: FAB内部布局更新，变为由居中竖线分隔的两个新按钮：左侧为**"继续录音"**，右侧为**"发送"**
3. **发送笔记**: 用户点击**"发送"按钮**，当前笔记内容被捕获并**在主界面生成一张新的笔记卡片**，随后FAB和对话框恢复初始状态

### 3.2 交互模式二：三连击 (启动高级总结模式)

- **触发条件**: 用户对FAB执行快速、连续的三次点击
- **响应流程**:
  1. 系统同时弹出位于FAB上方的**笔记对话框**和位于屏幕顶部的**实时总结对话框**
  2. FAB形态变为长条，内部显示**"暂停"文字按钮**，并开始语音识别
  3. 每2秒自动生成最新10个词的摘要
  4. 后续操作（暂停、继续、发送）与长按模式完全一致，点击**"发送"按钮**后同样会创建一张新的笔记卡片

### 3.3 交互模式三：短按 (启动手动笔记)

- **触发条件**: 用户对FAB执行一次**时长小于0.25秒**的短按操作
- **响应流程**:
  1. 在FAB正上方，立即弹出一个**笔记对话框**，等待用户键盘输入
  2. FAB自身形态变为长条，内部由居中竖线隔开两个按钮：左侧为**"录音"**，右侧为**"发送"**
  3. 点击**"发送"按钮**后，会将当前输入的文本**创建为一张新的笔记卡片**

### 3.4 交互模式四：上滑 (启动MCP中心)

- **触发条件**: 用户在FAB上执行一次**向上滑动**的手势
- **响应流程**:
  1. 从屏幕底部平滑拉起**MCP中心面板**（参考2.8）
  2. 用户可在此面板中选择并启动各种MCP应用

### 3.5 交互模式五：双击 (切换到会议Agent模式) [V1.1新增]

- **触发条件**: 用户对FAB执行快速的**双击**操作（间隔小于300ms）
- **响应流程**:
  1. 应用切换到会议Agent模式
  2. 显示蓝色呼吸灯边框效果
  3. 自动开始语音识别和VAD检测
  4. 显示意图识别面板和搜索结果面板
  5. FAB保持展开状态
- **退出方式**: 再次双击FAB或按ESC键

### 3.6 笔记卡片交互

**3.6.1 单击：选中卡片**
- **行为**: 在卡片上单击，卡片呈现选中状态（例如边框高亮或背景色变化）
- **多选**: 支持连续单击选中多张卡片。再次单击已选中的卡片则取消该卡片的选中状态

**3.6.2 双击：编辑卡片**
- **行为**: 在任意一张卡片上双击
- **响应**: 在屏幕下方，弹出一个与初始笔记对话框**位置和样式完全相同**的**编辑视图**。该视图内自动载入被双击卡片的文本内容，供用户修改。编辑完成后，提供保存或取消的选项

**3.6.3 拖拽：触发批量操作**
- **触发条件**: 当有1张或多张卡片处于选中状态时，用户按住并拖动**任意一张被选中的卡片**
- **响应**: 立即触发并显示**卡片批量操作视图（参考2.5）**。用户可以在此视图的右侧选择要执行的批量操作

### 3.7 文本输入与智能符号系统 (Text Input & Sigil System)

**3.7.1 通用交互规则**
1. **触发**: 用户输入 `#`, `@`, 或 `!` 字符，立即触发**建议弹出框**
2. **筛选**: 继续输入，建议列表根据内容实时筛选
3. **键盘导航**: `↑`/`↓`键可导航建议项，列表随之滚动确保高亮项可见
4. **补全**: 按`Tab`键或在建议列表打开时按`Enter`键，可将输入内容补全为高亮建议项
5. **创建**: 输入**空格**或在无建议列表时按**回车**，可将光标前完整的符号文本（如`#标签`）转换为独立的"**符号块**"（Pill），并阻止换行/空格输入
6. **关闭建议**: 按`ESC`键或移动端返回键可关闭建议弹出框

**3.7.2 `#` 标签 (Tag)**
- **用途**: 对笔记进行分类和归档
- **数据源**: 历史创建过的所有标签
- **样式**: 蓝色背景的符号块

**3.7.3 `@` 提及 (@Mention)**
- **用途**: 提及联系人，用于未来共享或指派
- **数据源**: 模拟的好友列表（参考5.0附录）
- **样式**: 绿色背景的符号块

**3.7.4 `!` 函数 (!Function)**
- **用途**: 调用预设的快捷命令或AI服务
- **数据源**: 模拟的函数/服务列表（参考5.0附录）
- **样式**: 紫色背景的符号块

### 3.8 搜索功能 (Search Functionality)

- **触发**: 用户点击或聚焦于屏幕顶部的**搜索框**
- **行为**:
  1. **实时过滤**: 用户在搜索框中输入内容时，主界面的笔记卡片列表应**实时更新**，仅显示符合搜索条件的笔记
  2. **文本搜索**: 直接输入普通文字，系统将对所有笔记的**文本内容**进行全文匹配搜索
  3. **标签搜索**: 输入以 `#` 开头的文本（例如 `#项目`），系统将仅筛选出包含该标签的笔记
  4. **清空搜索**: 当搜索框内容被清空时，笔记列表恢复到初始状态，显示所有笔记

## 4.0 会议Agent模式功能 [V1.1新增]

### 4.1 语音识别模块

- **技术实现**: Web Speech API
- **功能特性**:
  - 持续流式识别，实时返回结果
  - 自动语言检测（中文优先）
  - 支持interim results，提供即时反馈
  - 长时间录音自动续接

### 4.2 语音活动检测（VAD）

- **技术实现**: TEN-VAD (WebAssembly)
- **核心参数**:
  - 采样率：16kHz
  - 窗口大小：256样本（16ms/帧）
  - 检测阈值：0.5
  - 静音判定：800ms
- **功能特性**:
  - 实时检测说话/静音状态
  - 高精度避免误触发
  - 低延迟响应（<50ms）

### 4.3 智能意图识别

- **技术实现**: Gemini 2.0 Flash API
- **触发机制**:
  1. **字符触发**: 新增10个字符时触发
  2. **静默触发**: VAD检测到800ms静音后触发
  3. **防重复**: 字符触发后3秒内不进行静默触发
- **意图类型**:
  - `search`: 信息搜索查询
  - `memory`: 历史记录查询
  - `command`: 命令执行
  - `none`: 无明确意图（被过滤）
- **API调用流程**:
  ```
  用户说话 → 语音识别 → 文本累积 → 触发检测
    ├─ 字符触发（每10字符）
    └─ 静音触发（800ms静音）
         ↓
  Gemini API调用 → 返回意图数组 → 过滤type='none'
         ↓
  获取首个有效意图 → 执行搜索/命令
  ```
- **响应处理**:
  - 支持数组格式响应
  - 自动过滤type='none'的结果
  - 返回首个有效意图

### 4.4 搜索与知识管理

- **双层架构**:
  1. **RAG知识库**: 优先搜索本地知识库
  2. **外部搜索**: RAG无结果时使用Gemini生成
- **去重机制**:
  - 维护最近5条搜索历史
  - 语义相似度检测
  - 重复查询自动过滤

### 4.5 语音合成（TTS）

- **技术实现**: Web Speech Synthesis API
- **唤醒词**: "小爱同学"
- **功能特性**:
  - 仅在检测到唤醒词后激活
  - 自动总结搜索结果
  - 支持中文语音输出

## 5.0 全局规则与非功能性需求

- **UI风格**: 严格遵循纯白背景、黑色文字的简约设计，界面中不应出现透明或拟物风格元素（批量操作视图的毛玻璃背景除外）
- **内容持久性**: 在同一个笔记会话中，无论是语音输入还是手动打字，文本内容都应持续追加，永不自动清空
- **组件持久性**: 一旦笔记对话框被任何方式触发并显示，FAB本身必须始终保持可见，并作为后续操作的主要控制器
- **文案精简**: 界面中移除"语音笔记"等多余的标题性文字，追求极致简约
- **标签持久性**: 系统需要维护一个全局的、唯一的标签库。所有被成功创建的标签都应被持久化存储，以便在所有笔记的创建和编辑过程中提供统一的输入建议
- **全局关闭手势**: 用户可通过按`ESC`键或移动端返回键，关闭任何当前打开的模态化视图，包括：
  - 笔记对话框 / 编辑视图
  - 卡片批量操作视图
  - MCP中心面板
  - 会议Agent模式
  - 用户个人中心
- **数据持久化**: 使用localStorage存储笔记数据、用户设置、API密钥等

## 6.0 技术要求 [V1.1新增]

### 6.1 必需配置

- **浏览器**: Chrome/Edge 88+, Firefox 85+
- **权限**: 麦克风访问权限
- **网络**: HTTPS环境（Web Speech API要求）
- **API密钥**: Gemini API（会议模式必需）

### 6.2 性能优化

- **防抖和节流**:
  - API调用最小间隔：1秒
  - 意图检测字符阈值：10字符
  - VAD静音检测：800ms
- **资源管理**:
  - 音频上下文复用
  - WebAssembly预加载
  - 事件监听器清理

## 7.0 附录：数据定义

### 7.1 Mock数据

- **`@` 提及好友列表**:
  - `["张三", "李四", "项目经理小王", "设计师伙伴", "产品经理", "开发团队"]`
- **`!` 函数/MCP服务列表**:
  - `["总结全文", "创建待办事项", "发送邮件给", "翻译成英文", "提醒我", "分享到微信"]`
- **MCP中心应用列表**:
  - `["AI 摘要", "任务清单", "图表生成", "会议助手", "灵感白板"]`

### 7.2 关键交互时间阈值

| 交互 | 时间阈值 | 说明 |
|------|----------|------|
| 短按 | < 250ms | 手动笔记 |
| 双击间隔 | < 300ms | 会议模式 |
| 录音启动 | 250ms | 开始录音 |
| 快速笔记 | 800ms-2.1s | 自动保存 |
| 对话框弹出 | 2.1s | 展开界面 |
| VAD静音 | 800ms | 触发意图 |
| 字符触发 | 10字符 | 检测意图 |
| API防抖 | 1000ms | 最小间隔 |

## 8.0 未来扩展方向

1. **跨模式联动**: 会议内容自动生成笔记卡片
2. **多语言支持**: 扩展到英文等其他语言的会议支持
3. **离线能力**: 集成本地意图识别模型
4. **协作功能**: 支持多人会议实时协作
5. **AI增强**: 自动会议纪要、行动项提取等
6. **数据导出**: 支持导出为Markdown、PDF等格式
7. **云同步**: 支持多设备数据同步